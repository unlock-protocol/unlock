version: '3.2'
services:
  
  eth-node:
    restart: always
    build:
      context: ./development/eth-node
    ports:
      - 8545:8545

  jaeger:
    restart: always
    image: jaegertracing/all-in-one:1.25
    ports:
      - '5775:5775/udp'
      - '6831:6831/udp'
      - '6832:6832/udp'
      - '5778:5778'
      - '16686:16686'
      - '14268:14268'
      - '9411:9411'

  postgres:
    command: ['postgres', '-cshared_preload_libraries=pg_stat_statements']
    env_file: development.env
    ports:
      - '5432:5432'

  locksmith-migration:
    env_file: development.env
    image: locksmith
    build:
      context: ../
      args:
        BUILD_DIR: locksmith
      cache_from:
        - locksmith
        - unlockprotocol/locksmith:master
    command: yarn db:migrate
    depends_on:
      - postgres
      - eth-node

  locksmith:
    env_file: development.env
    image: locksmith
    build:
      context: ../
      args:
        BUILD_DIR: locksmith
      cache_from:
        - locksmith
        - unlockprotocol/locksmith:master
    ports:
      - '8080:8080'
    depends_on:
      - postgres
      - eth-node

  subgraph_deployment:
    build:
      context: ./development
      dockerfile: subgraph.dockerfile
    command: ['node', './deploy-subgraph.js']
    depends_on:
      - graph-node

  wedlocks:
    image: wedlocks
    build:
      context: ../
      args:
          BUILD_DIR: locksmith
    command: yarn dev
    env_file: development.env
    ports:
      - '1337:1337'

  graph-node:
    env_file: development.env
    depends_on:
      - ipfs
      - postgres
