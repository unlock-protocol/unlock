name: Pull Request

on:
  pull_request:

jobs:
  # check which folder changed in the repo
  check-changes:
    uses: ./.github/workflows/_check.yml
    with:
      targets: '[
        "locksmith",
        "packages/contracts",
        "packages/hardhat-plugin",
        "packages/unlock-js",
        "packages/paywall",
        "smart-contracts",
        "subgraph",
        "governance",
        "provider",
        "unlock-protocol-com",
        "wedlocks",
        "unlock-app",
        "packages/core",
        "docs"
        ]'
      # run all tests if PR contains the 'run-all-tests' tag
      bypass: ${{ contains(github.event.pull_request.labels.*.name, 'run-all-tests')}}

  deploy-locksmith-staging-railway:
    if: ${{ github.event.pull_request.head.repo.full_name == github.repository }}
    name: Deploy locksmith on Railway (Staging)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Load secrets from 1Password
        uses: 1Password/load-secrets-action@v2.0.0
        with:
          export-env: true
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          RAILWAY_TOKEN: op://secrets/railway/railway-token
          SVC_ID: op://secrets/railway/locksmith-staging-service-id

      - name: Install Railway CLI
        run: npm i -g @railway/cli

      - name: Configure 1Password Token in Railway
        run: railway variables add OP_SERVICE_ACCOUNT_TOKEN "${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}" --service=${{ env.SVC_ID }}

      - name: Deploy to Railway
        run: railway up --service=${{ env.SVC_ID }}
