name: Pull Request

on:
  pull_request:

jobs:
  # check which folder changed in the repo
  check-changes:
    uses: ./.github/workflows/_check.yml
    with:
      targets: '[
        "locksmith",
        "packages/contracts",
        "packages/hardhat-plugin",
        "packages/unlock-js",
        "packages/paywall",
        "smart-contracts",
        "subgraph",
        "governance",
        "provider",
        "unlock-protocol-com",
        "wedlocks",
        "unlock-app",
        "packages/core",
        "docs"
        ]'
      # run all tests if PR contains the 'run-all-tests' tag
      bypass: ${{ contains(github.event.pull_request.labels.*.name, 'run-all-tests')}}

  deploy-locksmith-staging-railway:
    if: ${{ github.event.pull_request.head.repo.full_name == github.repository }}
    name: Deploy locksmith web on Railway (Staging)
    uses: ./.github/workflows/_railway.yml
    with:
      service: locksmith-web
      service-id: op://secrets/railway/locksmith-staging-service-id
      bypass_diff_check: bypass
    secrets:
      railway-token: op://secrets/railway/railway-token
      OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}

  deploy-locksmith-worker-staging-railway:
    if: ${{ github.event.pull_request.head.repo.full_name == github.repository }}
    name: Deploy locksmith worker on Railway (Staging)
    uses: ./.github/workflows/_railway.yml
    with:
      service: locksmith-worker
      service-id: op://secrets/railway/locksmith-staging-worker-service-id
      bypass_diff_check: bypass
    secrets:
      railway-token: op://secrets/railway/railway-token
      OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
